// =======================================================
// CONFIGURA√á√ïES - INTELIG√äNCIA DE MERCADO
// =======================================================
const ID_PLANILHA_INTELIGENCIA = '1mMBEBDBqp6_-hOD_kZvmX2eBHbACMCFzUsvnZPdOksw';
const ABA_REGISTRO = 'REGISTRO_PRODUTOS';
const ABA_CATALOGO = 'CATALOGO_PRODUTOS';

// Configura√ß√µes da OpenAI API
const OPENAI_API_KEY = ''; // Substitua pela sua chave
const OPENAI_MODEL = 'gpt-4o-mini'; // Op√ß√µes: gpt-4o-mini, gpt-4o, gpt-3.5-turbo

// =======================================================
// PROCESSA MENSAGENS E EXTRAI INSIGHTS
// =======================================================
function processarMensagensParaInteligencia() {
  try {
    Logger.log('üîç Iniciando processamento de intelig√™ncia de mercado...');
    
    var ssMonitoramento = SpreadsheetApp.openById('1fxNaD6uSLmdiQ5WAVno3u2XialE9SQcowkVjeirbPFY');
    var ssInteligencia  = SpreadsheetApp.openById(ID_PLANILHA_INTELIGENCIA);
    
    var sheetRegistro = ssInteligencia.getSheetByName(ABA_REGISTRO);
    var sheetCatalogo = ssInteligencia.getSheetByName(ABA_CATALOGO);
    
    if (!sheetRegistro || !sheetCatalogo) {
      Logger.log('‚ùå Abas n√£o encontradas. Crie REGISTRO_PRODUTOS e CATALOGO_PRODUTOS');
      return;
    }
    
    // Busca cat√°logo de produtos
    var ultimaLinhaCatalogo = sheetCatalogo.getLastRow();
    if (ultimaLinhaCatalogo < 2) {
      Logger.log('‚ö†Ô∏è Cat√°logo vazio! Preencha a aba CATALOGO_PRODUTOS');
      return;
    }
    
    var catalogoData = sheetCatalogo.getRange(2, 1, ultimaLinhaCatalogo - 1, 3).getValues();
    var catalogoProdutos = catalogoData.map(function(row) { 
      return row[0].toString().toLowerCase().trim(); 
    }).filter(function(p) { return p !== ''; });
    
    Logger.log('üì¶ Cat√°logo carregado: ' + catalogoProdutos.length + ' produtos');
    
    // Busca mensagens das 3 abas de monitoramento
    var abasMonitoramento = ['CANTINA_DIGISAC', 'LUMAR_DIGISAC', 'LUMAR_NOVOS'];
    var novasEntradas = [];
    
    // Busca IDs j√° processados
    var ultimaLinhaRegistro = sheetRegistro.getLastRow();
    var idsProcessados = {};
    if (ultimaLinhaRegistro > 1) {
      var registrosExistentes = sheetRegistro.getRange(2, 7, ultimaLinhaRegistro - 1, 1).getValues();
      registrosExistentes.forEach(function(row) {
        var msg = row[0].toString();
        if (msg) idsProcessados[msg] = true;
      });
    }
    
    for (var a = 0; a < abasMonitoramento.length; a++) {
      var nomeAba = abasMonitoramento[a];
      var origem = nomeAba.includes('CANTINA') ? 'CANTINA EM CASA' : 'LUMAR ALIMENTOS';
      
      var sheetMonit = ssMonitoramento.getSheetByName(nomeAba);
      if (!sheetMonit) {
        Logger.log('‚ö†Ô∏è Aba ' + nomeAba + ' n√£o encontrada');
        continue;
      }
      
      var ultimaLinha = sheetMonit.getLastRow();
      if (ultimaLinha < 2) continue;
      
      // Pega √∫ltimas 50 mensagens
      var inicio = Math.max(2, ultimaLinha - 49);
      var dados = sheetMonit.getRange(inicio, 1, ultimaLinha - inicio + 1, 9).getValues();
      
      for (var i = 0; i < dados.length; i++) {
        var data     = dados[i][0];
        var cliente  = dados[i][1];
        var tipo     = dados[i][7]; // Coluna H - TIPO
        var mensagem = dados[i][8]; // Coluna I - Mensagem
        
        if (!mensagem || mensagem === '') continue;
        if (idsProcessados[mensagem]) continue; // J√° processado
        
        // Filtra apenas mensagens relevantes
        var tipoUpper = tipo.toString().toUpperCase();
        if (!tipoUpper.match(/RECLAMA√á√ÉO|QUALIDADE|PROBLEMA|D√öVIDA|PEDIDO/)) continue;
        
        // Classifica a mensagem
        var analise = classificarMensagemComIA(mensagem, catalogoProdutos);
        
        // Filtros adicionais
        var produtoValido = analise.produto && 
                            analise.produto !== 'null' && 
                            analise.produto !== '' &&
                            analise.produto !== '(n√£o identificado)' &&
                            analise.produto.toLowerCase() !== 'null';
        
        if (analise.categoria !== 'IRRELEVANTE' && produtoValido) {
          novasEntradas.push([
            data,
            origem,
            cliente,
            analise.categoria,
            analise.produto,
            analise.tipo || '',
            mensagem,
            'üÜï Novo',
            ''
          ]);
          
          idsProcessados[mensagem] = true;
        }
      }
    }
    
    // Insere novos registros
    if (novasEntradas.length > 0) {
      var proximaLinha = sheetRegistro.getLastRow() + 1;
      sheetRegistro.getRange(proximaLinha, 1, novasEntradas.length, 9).setValues(novasEntradas);
      Logger.log('‚úÖ ' + novasEntradas.length + ' novos insights registrados!');
    } else {
      Logger.log('‚úÖ Nenhuma nova mensagem relevante encontrada.');
    }
    
  } catch (err) {
    Logger.log('‚ùå ERRO: ' + err.toString());
    Logger.log('Stack: ' + err.stack);
  }
}

// =======================================================
// CLASSIFICA MENSAGEM (Vers√£o sem IA - baseada em palavras-chave)
// =======================================================
function classificarMensagem(mensagem, catalogoProdutos) {
  var msgLower = mensagem.toLowerCase();
  
  // Detecta categoria
  var categoria = 'IRRELEVANTE';
  
  // üî¥ PROBLEMA
  if (msgLower.match(/problema|defeito|errado|queimado|cru|duro|mole|ruim|horr√≠vel|p√©ssimo|estragado|vencido|azedo/i)) {
    categoria = 'üî¥ PROBLEMA';
  }
  // üü° PREPARO
  else if (msgLower.match(/como prepara|como faz|como assa|temperatura|tempo de forno|quanto tempo|como cozinha|instru√ß√£o|receita/i)) {
    categoria = 'üü° PREPARO';
  }
  // üü¢ OPORTUNIDADE
  else if (msgLower.match(/tem |vende |voc√™s tem|tem o|existe|produz|faz |gostaria de|queria|preciso de|onde encontro/i)) {
    categoria = 'üü¢ OPORTUNIDADE';
  }
  
  // Detecta produto mencionado
  var produtoEncontrado = '';
  var tipoProduto = '';
  
  for (var i = 0; i < catalogoProdutos.length; i++) {
    var produtoCatalogo = catalogoProdutos[i];
    if (msgLower.includes(produtoCatalogo)) {
      produtoEncontrado = produtoCatalogo.toUpperCase();
      tipoProduto = 'Cat√°logo Atual';
      break;
    }
  }
  
  // Se n√£o encontrou no cat√°logo, tenta extrair da mensagem
  if (!produtoEncontrado && categoria === 'üü¢ OPORTUNIDADE') {
    var match = msgLower.match(/(?:tem|vende|produz|faz)\s+([a-z√†-√∫\s]{3,30})(?:\?|$|\s)/i);
    if (match) {
      produtoEncontrado = match[1].trim().toUpperCase();
      tipoProduto = 'üí° Produto Novo';
    }
  }
  
  if (!produtoEncontrado) {
    produtoEncontrado = '(n√£o identificado)';
    tipoProduto = '';
  }
  
  return {
    categoria: categoria,
    produto: produtoEncontrado,
    tipo: tipoProduto
  };
}

// =======================================================
// VERS√ÉO COM IA (OpenAI) - OTIMIZADA
// =======================================================
function classificarMensagemComIA(mensagem, catalogoProdutos) {
  if (!OPENAI_API_KEY || OPENAI_API_KEY === 'SUA_CHAVE_OPENAI_AQUI') {
    Logger.log('‚ö†Ô∏è Chave OpenAI n√£o configurada, usando classifica√ß√£o por palavras-chave');
    return classificarMensagem(mensagem, catalogoProdutos);
  }
  
  var prompt = `Voc√™ √© um analista de produtos para uma empresa de panifica√ß√£o congelada.

MENSAGEM DO CLIENTE: "${mensagem}"

CAT√ÅLOGO DE PRODUTOS ATUAIS: ${catalogoProdutos.join(', ')}

TAREFA: Classifique a mensagem em uma das categorias abaixo. Retorne APENAS um JSON v√°lido.

CATEGORIAS:

1. üî¥ PROBLEMA
   - Cliente reclama de defeito, qualidade ruim, produto estragado
   - Produto veio errado, queimado, cru, duro, azedo, vencido
   - Exemplos: "p√£o de queijo veio queimado", "rosca est√° dura"

2. üü¢ OPORTUNIDADE (APENAS PRODUTOS ALIMENT√çCIOS)
   - Cliente pergunta se voc√™s VENDEM/TEM/PRODUZEM um produto ESPEC√çFICO
   - Menciona nome de COMIDA/ALIMENTO que quer comprar
   - IGNORE: perguntas sobre entrega, pagamento, hor√°rio, procedimentos
   - Exemplos v√°lidos: "voc√™s fazem pizza?", "tem p√£o integral?"
   - Exemplos INV√ÅLIDOS: "aceitam PIX?", "fazem entrega?", "qual hor√°rio?"

3. üü° PREPARO
   - Cliente pergunta COMO preparar/assar/fazer um produto ESPEC√çFICO
   - Quer saber temperatura, tempo de forno, instru√ß√µes
   - Exemplos: "como assar o croissant?", "quanto tempo no forno?"

4. IRRELEVANTE
   - Perguntas sobre: pagamento, entrega, hor√°rio, localiza√ß√£o, procedimentos
   - N√£o menciona produto aliment√≠cio espec√≠fico
   - Mensagens gen√©ricas sem foco em produto
   - Exemplos: "aceitam cart√£o?", "fazem entrega?", "est√£o abertos?"

REGRAS IMPORTANTES:
- Se a mensagem menciona "diversos produtos", "v√°rios itens", "tudo" SEM especificar ‚Üí IRRELEVANTE
- Se pergunta sobre PIX, cart√£o, boleto, pagamento ‚Üí IRRELEVANTE
- Se pergunta sobre entrega, hor√°rio, localiza√ß√£o ‚Üí IRRELEVANTE
- Se pergunta sobre QR Code, altera√ß√£o de pedido ‚Üí IRRELEVANTE
- PRODUTO deve ser o NOME ESPEC√çFICO do alimento mencionado (ex: "P√ÉO INTEGRAL", "PIZZA")
- Se n√£o conseguir identificar produto espec√≠fico ‚Üí IRRELEVANTE
- Se produto est√° no CAT√ÅLOGO ‚Üí tipo = "Cat√°logo Atual"
- Se produto N√ÉO est√° no CAT√ÅLOGO ‚Üí tipo = "üí° Produto Novo"

FORMATO DA RESPOSTA (JSON v√°lido):
{
  "categoria": "üî¥ PROBLEMA" ou "üü¢ OPORTUNIDADE" ou "üü° PREPARO" ou "IRRELEVANTE",
  "produto": "NOME DO PRODUTO EM MAI√öSCULAS" ou "null" se n√£o identificado,
  "tipo": "Cat√°logo Atual" ou "üí° Produto Novo" ou "null"
}`;

  var options = {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + OPENAI_API_KEY },
    payload: JSON.stringify({
      model: OPENAI_MODEL,
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.2,
      response_format: { type: "json_object" }
    }),
    muteHttpExceptions: true
  };
  
  try {
    var response = UrlFetchApp.fetch('https://api.openai.com/v1/chat/completions', options);
    var json = JSON.parse(response.getContentText());
    
    if (json.error) {
      Logger.log('‚ùå Erro da OpenAI: ' + json.error.message);
      return classificarMensagem(mensagem, catalogoProdutos);
    }
    
    var resultado = JSON.parse(json.choices[0].message.content);
    
    // Valida√ß√£o adicional
    if (resultado.produto === 'null' || !resultado.produto || resultado.produto === '' || resultado.produto.toLowerCase() === 'null') {
      resultado.categoria = 'IRRELEVANTE';
      resultado.produto = '(n√£o identificado)';
    }
    
    Logger.log('‚úÖ IA classificou: ' + resultado.categoria + ' - ' + resultado.produto);
    return resultado;
  } catch (err) {
    Logger.log('‚ö†Ô∏è Erro na IA, usando fallback: ' + err);
    return classificarMensagem(mensagem, catalogoProdutos);
  }
}

// =======================================================
// CRIAR TRIGGER - Roda a cada 10 minutos
// =======================================================
function criarTriggerInteligencia() {
  // Remove triggers antigos
  var triggers = ScriptApp.getProjectTriggers();
  var removidos = 0;
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'processarMensagensParaInteligencia') {
      ScriptApp.deleteTrigger(triggers[i]);
      removidos++;
    }
  }
  
  if (removidos > 0) {
    Logger.log('üóëÔ∏è ' + removidos + ' trigger(s) antigo(s) removido(s)');
  }
  
  // Cria novo trigger
  ScriptApp.newTrigger('processarMensagensParaInteligencia')
    .timeBased()
    .everyMinutes(10)
    .create();
  
  Logger.log('‚úÖ Trigger de intelig√™ncia criado! Processar√° mensagens a cada 10 minutos.');
  Logger.log('üìä Modelo configurado: ' + OPENAI_MODEL);
  Logger.log('üîë API Key configurada: ' + (OPENAI_API_KEY !== 'SUA_CHAVE_OPENAI_AQUI' ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå'));
}

// =======================================================
// TESTAR CLASSIFICA√á√ÉO - Para validar antes de rodar
// =======================================================
function testarClassificacao() {
  Logger.log('üß™ === TESTE DE CLASSIFICA√á√ÉO ===');
  
  var catalogoTeste = ['p√£o de queijo', 'p√£o franc√™s', 'esfiha', 'croissant', 'rosca', 'p√£o de batata'];
  
  var mensagensTeste = [
    'O p√£o de queijo veio queimado e duro',
    'Voc√™s vendem p√£o integral?',
    'Como devo assar o croissant congelado?',
    'Tem pizza congelada?',
    'Aceitam PIX?',
    'Fazem entrega no Setor Bueno?',
    'Qual o hor√°rio de funcionamento?',
    'A rosca est√° muito dura, pode trocar?',
    'Tem diversos produtos dispon√≠veis?'
  ];
  
  for (var i = 0; i < mensagensTeste.length; i++) {
    Logger.log('\nüìù Mensagem ' + (i + 1) + ': "' + mensagensTeste[i] + '"');
    var resultado = classificarMensagemComIA(mensagensTeste[i], catalogoTeste);
    Logger.log('   Categoria: ' + resultado.categoria);
    Logger.log('   Produto: ' + resultado.produto);
    Logger.log('   Tipo: ' + resultado.tipo);
  }
  
  Logger.log('\nüèÅ Teste conclu√≠do!');
}

// =======================================================
// LIMPAR REGISTROS - Use para reprocessar tudo
// =======================================================
function limparRegistros() {
  var ss = SpreadsheetApp.openById(ID_PLANILHA_INTELIGENCIA);
  var sheet = ss.getSheetByName(ABA_REGISTRO);
  
  if (!sheet) {
    Logger.log('‚ùå Aba REGISTRO_PRODUTOS n√£o encontrada');
    return;
  }
  
  var ultimaLinha = sheet.getLastRow();
  if (ultimaLinha > 1) {
    sheet.getRange(2, 1, ultimaLinha - 1, 9).clearContent();
    Logger.log('‚úÖ ' + (ultimaLinha - 1) + ' registros limpos!');
  } else {
    Logger.log('‚úÖ Aba j√° est√° vazia.');
  }
}
