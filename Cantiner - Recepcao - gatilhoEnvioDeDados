// =======================================================
// CONFIGURAÃ‡Ã•ES
// =======================================================
const ID_PLANILHA_COMERCIAL = '15ygrVoRh7cd8iVWn0eBXpEz-jBVsOa4jxemmmva2rnA';
const ABA_DESTINO = 'TESTE';
const ABA_RECEPCAO = 'recepcao';

const IDS_IGNORADOS = ['1013314', '1013311', '1058077', '1198553'];
const COLUNAS_FORMULAS = [6, 7, 8, 9, 12];

// =======================================================
// GATILHO PRINCIPAL â€” Executa ao editar a RecepÃ§Ã£o
// =======================================================
function onEditRecepcao(e) {
  try {
    var sheet = e.range.getSheet();
    if (sheet.getName() !== ABA_RECEPCAO) return;

    var linha = e.range.getRow();
    if (linha < 2) return;

    var dados = sheet.getRange(linha, 1, 1, 8).getValues()[0];

    var idVenda    = String(dados[0]).trim();
    var venda      = dados[1];
    var idCliente  = String(dados[2]).trim();
    var valor      = dados[4];
    var dataAtuali = dados[7];

    if (!idVenda || idVenda === '') return;
    if (IDS_IGNORADOS.includes(idCliente)) {
      Logger.log('â­ï¸ id_cliente ignorado: ' + idCliente);
      return;
    }

    var ssComercial = SpreadsheetApp.openById(ID_PLANILHA_COMERCIAL);
    var sheetTeste  = ssComercial.getSheetByName(ABA_DESTINO);

    if (!sheetTeste) {
      Logger.log('âŒ Aba "' + ABA_DESTINO + '" nÃ£o encontrada!');
      return;
    }

    var linhaExistente = buscarLinhaPorIdVenda(sheetTeste, idVenda);

    if (linhaExistente) {
      // AtualizaÃ§Ã£o â€” SEM reescrever fÃ³rmulas
      atualizarLinha(sheetTeste, linhaExistente, venda, idCliente, valor, dataAtuali);
      Logger.log('âœï¸ Pedido atualizado â€” id_venda: ' + idVenda + ' | Linha: ' + linhaExistente);
    } else {
      // InserÃ§Ã£o â€” COM fÃ³rmulas pois a linha Ã© nova
      inserirLinha(sheetTeste, idVenda, venda, idCliente, valor, dataAtuali);
      Logger.log('âž• Novo pedido inserido â€” id_venda: ' + idVenda);
    }

  } catch(err) {
    Logger.log('âŒ ERRO em onEditRecepcao: ' + err.toString());
  }
}

// =======================================================
// BUSCA linha na TESTE pelo id_venda (Coluna B)
// =======================================================
function buscarLinhaPorIdVenda(sheet, idVenda) {
  var ultimaLinha = sheet.getLastRow();
  if (ultimaLinha < 2) return null;

  var ids = sheet.getRange(2, 2, ultimaLinha - 1, 1).getValues();
  for (var i = 0; i < ids.length; i++) {
    if (String(ids[i][0]).trim() === idVenda) return i + 2;
  }
  return null;
}

// =======================================================
// INSERE nova linha na TESTE â€” com fÃ³rmulas
// =======================================================
function inserirLinha(sheet, idVenda, venda, idCliente, valor, dataAtuali) {
  var novaLinha = proximaLinhaVaziaColB(sheet);

  sheet.getRange(novaLinha, 2, 1, 4).setValues([
    [idVenda, venda, converterParaNumero(idCliente), converterValor(valor)]
  ]);
  sheet.getRange(novaLinha, 15).setValue(dataAtuali);

  copiarFormulas(sheet, novaLinha); // SÃ³ em linhas novas
}

// =======================================================
// ATUALIZA linha existente â€” SEM reescrever fÃ³rmulas
// =======================================================
function atualizarLinha(sheet, linha, venda, idCliente, valor, dataAtuali) {
  sheet.getRange(linha, 3, 1, 3).setValues([
    [venda, converterParaNumero(idCliente), converterValor(valor)]
  ]);
  sheet.getRange(linha, 15).setValue(dataAtuali);
  // âŒ copiarFormulas removido â€” fÃ³rmulas jÃ¡ existem na linha
}

// =======================================================
// COPIA fÃ³rmulas da linha 2 â€” apenas para linhas NOVAS
// Verifica se jÃ¡ existe fÃ³rmula antes de copiar
// =======================================================
function copiarFormulas(sheet, linhaDestino) {
  if (linhaDestino === 2) return;

  for (var i = 0; i < COLUNAS_FORMULAS.length; i++) {
    var col     = COLUNAS_FORMULAS[i];
    var origem  = sheet.getRange(2, col);
    var destino = sheet.getRange(linhaDestino, col);

    // SÃ³ copia se a origem tem fÃ³rmula E o destino ainda estÃ¡ vazio
    if (origem.getFormula() !== '' && destino.getFormula() === '') {
      origem.copyTo(destino, SpreadsheetApp.CopyPasteType.PASTE_FORMULA, false);
    }
  }
}

// =======================================================
// AUXILIAR â€” PrÃ³xima linha vazia pela Coluna B
// =======================================================
function proximaLinhaVaziaColB(sheet) {
  var ultimaLinha = sheet.getLastRow();
  if (ultimaLinha < 2) return 2;

  var valoresColB = sheet.getRange(2, 2, ultimaLinha, 1).getValues();
  for (var i = 0; i < valoresColB.length; i++) {
    if (valoresColB[i][0] === '' || valoresColB[i][0] === null) return i + 2;
  }
  return ultimaLinha + 1;
}

// =======================================================
// AUXILIAR â€” Converte texto para nÃºmero inteiro
// =======================================================
function converterParaNumero(valor) {
  if (valor === null || valor === '') return '';
  var num = Number(String(valor).trim());
  return isNaN(num) ? valor : num;
}

// =======================================================
// AUXILIAR â€” Converte valor monetÃ¡rio para nÃºmero
// =======================================================
function converterValor(valor) {
  if (valor === null || valor === '') return '';
  if (typeof valor === 'number') return valor;

  var str = String(valor).trim().replace(/R\$\s?/g, '').trim();
  if (str.includes(',')) {
    str = str.replace(/\./g, '').replace(',', '.');
  }

  var numero = parseFloat(str);
  return isNaN(numero) ? valor : numero;
}

// =======================================================
// CRIAR GATILHO â€” Execute UMA VEZ para instalar o trigger
// =======================================================
function criarGatilhoRecepcao() {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'onEditRecepcao') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }

  ScriptApp.newTrigger('onEditRecepcao')
    .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
    .onEdit()
    .create();

  Logger.log('âœ… Gatilho criado com sucesso!');
}

// =======================================================
// SINCRONIZAÃ‡ÃƒO EM LOTES â€” Otimizada
// =======================================================
function sincronizacaoCompleta() {
  Logger.log('ðŸ”„ Iniciando sincronizaÃ§Ã£o otimizada...');

  var ssRecepcao  = SpreadsheetApp.getActiveSpreadsheet();
  var sheetRecep  = ssRecepcao.getSheetByName(ABA_RECEPCAO);
  var ssComercial = SpreadsheetApp.openById(ID_PLANILHA_COMERCIAL);
  var sheetTeste  = ssComercial.getSheetByName(ABA_DESTINO);

  if (!sheetRecep) { Logger.log('âŒ Aba RecepÃ§Ã£o nÃ£o encontrada!'); return; }
  if (!sheetTeste) { Logger.log('âŒ Aba TESTE nÃ£o encontrada!'); return; }

  var ultimaRecepcao = sheetRecep.getLastRow();
  if (ultimaRecepcao < 2) { Logger.log('âš ï¸ Sem dados na RecepÃ§Ã£o.'); return; }

  // 1. LÃŠ TUDO DE UMA VEZ
  var dadosRecepcao = sheetRecep.getRange(2, 1, ultimaRecepcao - 1, 8).getValues();

  // 2. MONTA MAPA DE IDs JÃ EXISTENTES NA TESTE
  var ultimaTeste = sheetTeste.getLastRow();
  var mapaIdsExistentes = {};
  if (ultimaTeste >= 2) {
    var idsExistentes = sheetTeste.getRange(2, 2, ultimaTeste - 1, 1).getValues();
    for (var x = 0; x < idsExistentes.length; x++) {
      var id = String(idsExistentes[x][0]).trim();
      if (id !== '') mapaIdsExistentes[id] = x + 2;
    }
  }

  // 3. SEPARA NOVOS E ATUALIZAÃ‡Ã•ES
  var novosParaInserir    = [];
  var linhasParaAtualizar = [];
  var ignorados = 0;

  for (var i = 0; i < dadosRecepcao.length; i++) {
    var idVenda   = String(dadosRecepcao[i][0]).trim();
    var idCliente = String(dadosRecepcao[i][2]).trim();

    if (!idVenda || idVenda === '') continue;
    if (IDS_IGNORADOS.includes(idCliente)) { ignorados++; continue; }

    var registro = {
      idVenda    : idVenda,
      venda      : dadosRecepcao[i][1],
      idCliente  : converterParaNumero(idCliente),
      valor      : converterValor(dadosRecepcao[i][4]),
      dataAtuali : dadosRecepcao[i][7]
    };

    if (mapaIdsExistentes[idVenda]) {
      registro.linha = mapaIdsExistentes[idVenda];
      linhasParaAtualizar.push(registro);
    } else {
      novosParaInserir.push(registro);
    }
  }

  Logger.log('ðŸ“Š Para inserir: '   + novosParaInserir.length);
  Logger.log('ðŸ“Š Para atualizar: ' + linhasParaAtualizar.length);
  Logger.log('ðŸ“Š Ignorados: '      + ignorados);

  // 4. ATUALIZA EXISTENTES â€” SEM fÃ³rmulas, apenas dados
  for (var u = 0; u < linhasParaAtualizar.length; u++) {
    var r = linhasParaAtualizar[u];
    sheetTeste.getRange(r.linha, 3, 1, 3).setValues([[r.venda, r.idCliente, r.valor]]);
    sheetTeste.getRange(r.linha, 15).setValue(r.dataAtuali);
    // âŒ Sem copiarFormulas â€” fÃ³rmulas jÃ¡ existem
  }

  // 5. INSERE NOVOS â€” COM fÃ³rmulas pois as linhas sÃ£o novas
  if (novosParaInserir.length > 0) {
    var proximaLinha = proximaLinhaVaziaColB(sheetTeste);

    for (var n = 0; n < novosParaInserir.length; n++) {
      var novo       = novosParaInserir[n];
      var linhaAtual = proximaLinha + n;

      sheetTeste.getRange(linhaAtual, 2, 1, 4).setValues([
        [novo.idVenda, novo.venda, novo.idCliente, novo.valor]
      ]);
      sheetTeste.getRange(linhaAtual, 15).setValue(novo.dataAtuali);
      copiarFormulas(sheetTeste, linhaAtual); // SÃ³ para linhas novas
    }
  }

  Logger.log('âœ… SincronizaÃ§Ã£o concluÃ­da!');
  Logger.log('   âž• Inseridos: '   + novosParaInserir.length);
  Logger.log('   âœï¸ Atualizados: ' + linhasParaAtualizar.length);
  Logger.log('   â­ï¸ Ignorados: '   + ignorados);
}
